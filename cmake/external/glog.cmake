SET(glog_URL https://github.com/google/glog)

IF(NOT gflags_FOUND)
    ExternalProject_Get_Property(gflags_project SOURCE_DIR)
    SET(glog_ADDITIONAL_CMAKE_OPTIONS "-DCMAKE_PREFIX_PATH=$<TARGET_PROPERTY:gflags,INCLUDE_DIRECTORIES>")
ENDIF()

IF(MSVC)
    SET(gflags_ADDITIONAL_CMAKE_OPTIONS "${glog_ADDITIONAL_CMAKE_OPTIONS} -G \"NMake MakeFiles\"")
ENDIF()

ExternalProject_Add(glog_project
        PREFIX glog
        GIT_REPOSITORY ${glog_URL}
        GIT_TAG "v${glog_VERSION}"
        DOWNLOAD_DIR "${DOWNLOAD_LOCATION}"
        UPDATE_COMMAND ""
        PATCH_COMMAND git am -3 ${CMAKE_SOURCE_DIR}/patches/glog_includedir_fix.patch
        BUILD_IN_SOURCE 1
        SOURCE_DIR ${CMAKE_CURRENT_BINARY_DIR}/glog_project/src/glog
        INSTALL_DIR ${CMAKE_CURRENT_BINARY_DIR}/install
        CONFIGURE_COMMAND ${CMAKE_COMMAND}
        -DWITH_GFLAGS=ON
        -DBUILD_TESTING=OFF
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON
        -DCMAKE_INSTALL_PREFIX=${CMAKE_CURRENT_BINARY_DIR}/install
        ${glog_ADDITIONAL_CMAKE_OPTIONS})

IF(NOT gflags_FOUND)
    ADD_DEPENDENCIES(glog_project gflags)
ENDIF()

ADD_LIBRARY(glog STATIC IMPORTED) 
SET_PROPERTY(TARGET glog
    PROPERTY IMPORTED_LOCATION
    ${CMAKE_CURRENT_BINARY_DIR}/install/lib/libglog.a)
SET_PROPERTY(TARGET glog
    PROPERTY INCLUDE_DIRECTORIES
    $<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}/install/include>
    $<INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}/${PROJECT_NAME}>)
ADD_DEPENDENCIES(glog glog_project)

SET(glog_LIBRARIES "")
LIST(APPEND glog_LIBRARIES glog)

INSTALL(DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/install/include/glog
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/${PROJECT_NAME}
    COMPONENT Devel)

SET(glog_INCLUDE_DIRS $<TARGET_PROPERTY:glog,INCLUDE_DIRECTORIES>)

LIST(APPEND ${PROJECT_NAME}_INCLUDE_DIRS ${CMAKE_INSTALL_INCLUDEDIR}/${PROJECT_NAME})
